{
  // See https://go.microsoft.com/fwlink/?LinkId=733558
  // Schema: https://code.visualstudio.com/docs/reference/tasks-appendix
  "$schema": "vscode://schemas/tasks",
  "version": "2.0.0",
  "presentation": {
    "echo": true,
    "clear": false,
    "panel": "dedicated",
    "showReuseMessage": false
  },
  "problemMatcher": [],
  "options": {
    "cwd": "${workspaceFolder}"
  },
  "tasks": [
    {
      "label": "Initialize: Pull, rebuild, and verify",
      "detail": "Pull latest, clean, rebuild, format, lint, and run tests",
      "dependsOn": [
        "Git: pull",
        "Clean: All outputs",
        "Build: All projects (full rebuild)",
        "Lint: All (fix)",
        "Test: All tests"
      ],
      "dependsOrder": "sequence",
      "group": "build",
      "problemMatcher": ["$tsc", "$msCompile", "$markdownlint"]
    },
    {
      "label": "Git: pull",
      "detail": "Pull latest changes from Git",
      "type": "shell",
      "command": "git pull || echo 'No remote branch'"
    },
    {
      "label": "Install: All package dependencies",
      "detail": "Restore NuGet and Node.js packages across workspaces",
      "dependsOn": ["Install: Packages (NuGet)", "Install: Packages (pnpm)"],
      "dependsOrder": "parallel"
    },
    {
      "label": "Install: Packages (pnpm)",
      "detail": "Restore Node.js packages across workspaces",
      "type": "shell",
      "command": "pnpm install"
    },
    {
      "label": "Install: Packages (NuGet)",
      "detail": "Restore .NET packages for solution",
      "type": "shell",
      "command": "dotnet restore Charts.sln",
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Clean: All outputs",
      "detail": "Clean build outputs from all projects",
      "dependsOn": [
        "Clean: Root and Azure storage",
        "Clean: Website outputs",
        "Clean: Backend .NET outputs"
      ],
      "dependsOrder": "parallel",
      "group": "build"
    },
    {
      "label": "Clean: Website outputs",
      "detail": "Clean Angular build outputs (dist, coverage)",
      "type": "shell",
      "command": "pnpm --filter @stock-charts/client run clean"
    },
    {
      "label": "Clean: Backend .NET outputs",
      "detail": "Clean .NET build outputs (bin, obj)",
      "type": "shell",
      "command": "dotnet clean Charts.sln -v minimal --nologo",
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Clean: Backend solution (hard reset)",
      "detail": "Deletes all bin/obj folders and runs dotnet clean command (hard clean)",
      "type": "shell",
      "command": "bash scripts/dotnet-clean.sh",
      "group": "build",
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Clean: Root and Azure storage",
      "detail": "Clean Azurite and root level items, including npm packages",
      "type": "shell",
      "command": "pnpm run clean"
    },
    {
      "label": "Build: All projects (incremental)",
      "detail": "Incremental build of Website and Backend .NET code",
      "dependsOn": ["Build: Backend .NET code (incremental)", "Build: Website"],
      "dependsOrder": "parallel",
      "group": {
        "kind": "build",
        "isDefault": true
      },
      "problemMatcher": ["$tsc", "$msCompile"]
    },
    {
      "label": "Build: All projects (full rebuild)",
      "detail": "Full rebuild without incremental compilation",
      "dependsOn": [
        "Clean: All outputs",
        "Build: Backend .NET code (non-incremental)",
        "Build: Website"
      ],
      "dependsOrder": "sequence",
      "group": "build",
      "problemMatcher": ["$tsc", "$msCompile"]
    },
    {
      "label": "Build: Website",
      "detail": "Build Angular application",
      "type": "shell",
      "command": "pnpm --filter @stock-charts/client run build",
      "group": "build",
      "problemMatcher": "$tsc",
      "dependsOn": "Install: Packages (pnpm)",
      "dependsOrder": "sequence"
    },
    {
      "label": "Build: Backend .NET code (non-incremental)",
      "detail": "Build .NET solution",
      "type": "shell",
      "command": "dotnet build Charts.sln -v minimal --nologo --no-incremental",
      "group": "build",
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Build: Backend .NET code (incremental)",
      "detail": "Build .NET solution",
      "type": "shell",
      "command": "dotnet build Charts.sln -v minimal --nologo",
      "group": "build",
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Build: Backend .NET code (production)",
      "detail": "Build .NET solution in Release configuration",
      "type": "shell",
      "command": "dotnet build Charts.sln -c Release -v minimal --nologo",
      "group": "build",
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Lint: All (check)",
      "detail": "Run all linting checks without fixes",
      "dependsOn": [
        "Lint: Website code (check)",
        "Lint: Backend .NET code (check)",
        "Lint: Markdown (check)"
      ],
      "dependsOrder": "parallel",
      "group": "test",
      "problemMatcher": "$markdownlint"
    },
    {
      "label": "Lint: All (fix)",
      "detail": "Auto-fix all linting issues",
      "dependsOn": ["Lint: All code (fix)", "Lint: Markdown (fix)"],
      "dependsOrder": "sequence",
      "group": "none",
      "problemMatcher": "$markdownlint"
    },
    {
      "label": "Lint: All code (fix)",
      "detail": "Format Website and Backend .NET code",
      "dependsOn": [
        "Lint: Website code (fix)",
        "Lint: Backend .NET code (fix)"
      ],
      "dependsOrder": "parallel",
      "group": "none",
      "problemMatcher": ["$tsc", "$markdownlint"]
    },
    {
      "label": "Lint: Website code (check)",
      "detail": "Check Angular code with ESLint",
      "type": "shell",
      "command": "pnpm --filter @stock-charts/client run lint",
      "group": "test",
      "problemMatcher": "$eslint-stylish"
    },
    {
      "label": "Lint: Website code (fix)",
      "detail": "Format Angular code with Prettier",
      "type": "shell",
      "command": "pnpm run format:web",
      "group": "none",
      "problemMatcher": "$tsc"
    },
    {
      "label": "Lint: Backend .NET code (check)",
      "detail": "Run Roslynator analysis and .NET format check",
      "type": "shell",
      "command": "dotnet format --verify-no-changes && roslynator analyze",
      "dependsOn": ["Build: Backend .NET code (incremental)"],
      "dependsOrder": "sequence",
      "group": "test",
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Lint: Backend .NET code (fix)",
      "detail": "Format Backend .NET code with dotnet format and Roslynator",
      "type": "shell",
      "command": "roslynator fix && dotnet format",
      "group": "none",
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Lint: Markdown (check)",
      "detail": "Lint markdown files",
      "type": "shell",
      "command": "pnpm run lint:md",
      "group": "test",
      "problemMatcher": "$markdownlint"
    },
    {
      "label": "Lint: Markdown (fix)",
      "detail": "Auto-fix markdown formatting issues",
      "type": "shell",
      "command": "pnpm run lint:md:fix",
      "group": "none",
      "problemMatcher": "$markdownlint"
    },
    {
      "label": "Test: All tests",
      "detail": "Run Website and Backend .NET code unit tests",
      "dependsOn": ["Test: Website", "Test: Backend .NET code"],
      "dependsOrder": "parallel",
      "group": "test",
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Test: Website",
      "detail": "Run Angular unit tests",
      "type": "shell",
      "command": "pnpm --filter @stock-charts/client run test",
      "group": "test",
      "problemMatcher": "$tsc",
      "presentation": { "clear": true }
    },
    {
      "label": "Test: Backend .NET code",
      "detail": "Run .NET unit tests",
      "type": "shell",
      "command": "pnpm run test:dotnet",
      "group": "test",
      "problemMatcher": "$msCompile",
      "presentation": { "clear": true }
    },
    {
      "label": "Run: Full development stack",
      "detail": "Start all Backend .NET code services and Website dev server",
      "dependsOn": [
        "Run: Azure Storage",
        "Run: Azure Functions",
        "Run: Web API",
        "Run: Website dev server"
      ],
      "dependsOrder": "sequence"
    },
    {
      "label": "Run: Azure Storage",
      "detail": "Start Azurite (Azure Storage Emulator)",
      "type": "shell",
      "command": "pnpm run azure:start",
      "isBackground": true,
      "problemMatcher": {
        "owner": "azure-storage",
        "pattern": { "regexp": "^$" },
        "background": {
          "activeOnStart": true,
          "beginsPattern": "^Azurite .* service is starting",
          "endsPattern": "^Azurite .* successfully listening"
        }
      },
      "presentation": {
        "clear": true
      }
    },
    {
      "label": "Run: Azure Functions",
      "detail": "Start Azure Functions host",
      "type": "shell",
      "command": "func start",
      "dependsOn": "Build: Backend .NET code (incremental)",
      "dependsOrder": "sequence",
      "isBackground": true,
      "options": {
        "cwd": "${workspaceFolder}/server/Functions"
      },
      "problemMatcher": {
        "owner": "azure-functions",
        "pattern": { "regexp": "^$" },
        "background": {
          "activeOnStart": true,
          "beginsPattern": "^.*Azure Functions",
          "endsPattern": "^.*Worker process started"
        }
      }
    },
    {
      "label": "Run: Web API",
      "detail": "Start ASP.NET Core Web API server",
      "type": "shell",
      "command": "dotnet run",
      "options": {
        "cwd": "${workspaceFolder}/server/WebApi"
      },
      "isBackground": true,
      "group": "none",
      "problemMatcher": {
        "owner": "web-api",
        "pattern": { "regexp": "^$" },
        "background": {
          "activeOnStart": true,
          "beginsPattern": "^.*Building",
          "endsPattern": "^.*Application started"
        }
      }
    },
    {
      "label": "Run: Website dev server",
      "detail": "Start Angular development server (with HMR)",
      "type": "shell",
      "command": "pnpm --filter @stock-charts/client run start",
      "isBackground": true,
      "group": "none",
      "problemMatcher": {
        "owner": "website",
        "pattern": { "regexp": "^$" },
        "background": {
          "activeOnStart": true,
          "beginsPattern": "^.*Compiling",
          "endsPattern": "^.*Application bundle generation complete"
        }
      }
    },
    {
      "label": "Stop: Backend services",
      "detail": "Stop backend services (Azure Functions + Web API)",
      "type": "shell",
      "command": "pnpm",
      "args": ["run", "stop:services"],
      "presentation": {
        "clear": true,
        "reveal": "always"
      },
      "group": "none"
    },
    {
      "label": "Stop: Website dev server",
      "detail": "Stop the Angular dev server (attempts to free default port 4200)",
      "type": "shell",
      "command": "npx",
      "args": ["kill-port", "4200"],
      "presentation": {
        "clear": true,
        "reveal": "always"
      },
      "group": "none"
    },
    {
      "label": "Stop: All services",
      "detail": "Gracefully stop all running Backend and Website services (cross-platform)",
      "dependsOn": ["Stop: Backend services", "Stop: Website dev server"],
      "dependsOrder": "sequence",
      "group": "none",
      "presentation": {
        "clear": true,
        "reveal": "always"
      }
    },

    // =========================================================================
    // CLEANUP
    // =========================================================================
    {
      "label": "Clean: temporary caches",
      "detail": "Delete build caches and lock files",
      "type": "shell",
      "command": "pnpm run clean && dotnet clean Charts.sln -v minimal --nologo",
      "group": "build",
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Clean: Azure Storage Emulator data",
      "detail": "Delete local Azurite data and state",
      "type": "shell",
      "command": "pnpm run azure:clean",
      "group": "none"
    }
  ]
}
